 
{% extends 'main_app/base.html' %}
{% load static %}
{% block page_title %}{{page_title}}{% endblock page_title %}

{% block custom_css %}
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
<style>
    .fc-event {
        cursor: move;
        padding: 2px 4px;
        border-radius: 3px;
        font-size: 0.85em;
    }
    .shift-A { background-color: #d4f4dd !important; color: #000 !important; border-color: #28a745 !important; }
    .shift-B { background-color: #fff0b3 !important; color: #000 !important; border-color: #ffc107 !important; }
    .shift-C { background-color: #f2d9ff !important; color: #000 !important; border-color: #6f42c1 !important; }
    .manual-override { border: 2px dashed #ff6b6b !important; }
    #calendar {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        padding: 20px;
    }
    .filters {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .fc-toolbar-title {
        font-size: 1.5em !important;
    }
</style>
{% endblock %}

{% block content %}
<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Shift Schedule Calendar</h3>
                        <div class="card-tools">
                            {% if request.user.user_type == '2' %}
                            <a href="{% url 'generate_shift_schedule' %}" class="btn btn-success">
                                <i class="fas fa-plus"></i> Generate New Schedule
                            </a>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-body">
                        
                        <!-- Filters -->
                        <div class="filters">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Select Schedule</label>
                                        <select id="scheduleSelect" class="form-control">
                                            <option value="">All Schedules</option>
                                            {% for schedule in schedules %}
                                            <option value="{{ schedule.id }}">
                                                {{ schedule.week_start_date }} to {{ schedule.week_end_date }}
                                            </option>
                                            {% empty %}
                                            <option value="">No schedules available</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                {% if request.user.user_type == '1' or request.user.user_type == '2' %}
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Filter by Department</label>
                                        <select id="departmentSelect" class="form-control">
                                            <option value="">All Departments</option>
                                            {% if request.user.user_type == '2' and division %}
                                                {% for dept in division.department_set.all %}
                                                <option value="{{ dept.id }}">{{ dept.name }}</option>
                                                {% endfor %}
                                            {% elif request.user.user_type == '1' and divisions %}
                                                {% for division in divisions %}
                                                <optgroup label="{{ division.name }}">
                                                    {% for dept in division.department_set.all %}
                                                    <option value="{{ dept.id }}">{{ dept.name }}</option>
                                                    {% endfor %}
                                                </optgroup>
                                                {% endfor %}
                                            {% endif %}
                                        </select>
                                    </div>
                                </div>
                                {% endif %}
                                {% if request.user.user_type == '3' and employee %}
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Employee</label>
                                        <input type="text" class="form-control" value="{{ employee }}" readonly>
                                        <input type="hidden" id="employeeSelect" value="{{ employee.id }}">
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Calendar -->
                        <div id="calendar"></div>

                        <!-- Legend -->
                        <div class="mt-3">
                            <h6>Shift Legend:</h6>
                            <span class="badge shift-A mr-2">Shift A (9:00-17:00)</span>
                            <span class="badge shift-B mr-2">Shift B (17:00-1:00)</span>
                            <span class="badge shift-C mr-2">Shift C (1:00-9:00)</span>
                            <span class="badge badge-secondary mr-2">Dashed Border = Manual Override</span>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block custom_js %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/interaction@5.11.3/main.min.js'></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'timeGridWeek',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        editable: {% if request.user.user_type == '2' %}true{% else %}false{% endif %},
        droppable: {% if request.user.user_type == '2' %}true{% else %}false{% endif %},
        slotMinTime: '00:00:00',
        slotMaxTime: '24:00:00',
        allDaySlot: false,
        eventDrop: function(info) {
            updateShiftAssignment(info.event);
        },
        eventResize: function(info) {
            updateShiftAssignment(info.event);
        },
        events: function(fetchInfo, successCallback, failureCallback) {
            var scheduleId = document.getElementById('scheduleSelect').value;
            var departmentId = document.getElementById('departmentSelect').value;
            var employeeId = document.getElementById('employeeSelect') ? document.getElementById('employeeSelect').value : '';
            
            var url = '{% url "get_shift_events" %}?';
            if (scheduleId) url += 'schedule_id=' + scheduleId + '&';
            if (departmentId) url += 'department_id=' + departmentId + '&';
            if (employeeId) url += 'employee_id=' + employeeId;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    var events = data.map(event => {
                        var className = 'shift-' + event.resource.shift_id;
                        if (event.resource.is_manual_override) {
                            className += ' manual-override';
                        }
                        return {
                            id: event.id,
                            title: event.title,
                            start: event.start,
                            end: event.end,
                            className: className,
                            extendedProps: event.resource
                        };
                    });
                    successCallback(events);
                })
                .catch(error => {
                    console.error('Error fetching events:', error);
                    failureCallback(error);
                });
        },
        eventContent: function(arg) {
            return {
                html: `
                    <div class="fc-event-main-frame">
                        <div class="fc-event-title">${arg.event.title}</div>
                        <div class="fc-event-time">${arg.timeText}</div>
                    </div>
                `
            };
        }
    });

    calendar.render();

    // Filter change handlers
    document.getElementById('scheduleSelect').addEventListener('change', function() {
        calendar.refetchEvents();
    });

    document.getElementById('departmentSelect').addEventListener('change', function() {
        calendar.refetchEvents();
    });

    function updateShiftAssignment(event) {
        const formData = new FormData();
        formData.append('shift_id', event.id);
        formData.append('new_date', event.start.toISOString().split('T')[0]);
        formData.append('new_start_time', event.start.toTimeString().split(' ')[0]);
        formData.append('new_end_time', event.end.toTimeString().split(' ')[0]);

        fetch('{% url "update_shift_assignment" %}', {
            method: 'POST',
            body: JSON.stringify(Object.fromEntries(formData)),
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                console.error('Error updating shift:', data.error);
                alert('Error updating shift: ' + data.error);
                event.revert();
            } else {
                // Show success message
                const toast = document.createElement('div');
                toast.className = 'alert alert-success alert-dismissible fade show';
                toast.innerHTML = `
                    <strong>Success!</strong> Shift assignment updated.
                    <button type="button" class="close" data-dismiss="alert">&times;</button>
                `;
                document.querySelector('.content').prepend(toast);
                
                // Auto remove after 3 seconds
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Network error occurred. Please try again.');
            event.revert();
        });
    }
});
</script>
{% endblock %}